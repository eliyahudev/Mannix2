import time
import r2d2
EDRAM_BASE      = 0x1b000000
EDRAM_OCP0      = EDRAM_BASE + 0x000000
EDRAM_OCP1      = EDRAM_BASE + 0x010000
EDRAM_CFG       = EDRAM_BASE + 0x080000
EDRAM_SRAM0     = EDRAM_BASE + 0x080800
EDRAM_SRAM0     = EDRAM_BASE + 0x081000
EDRAM_EFPGA_APB = EDRAM_BASE + 0x081800
EDRAM_EFPGA     = EDRAM_BASE + 0x100000

EDRAM_ENABLES = EDRAM_CFG + 0x40
EDRAM_E0_DRT  = EDRAM_CFG + 0x44
EDRAM_E1_DRT  = EDRAM_CFG + 0x48
EDRAM_E2_DRT  = EDRAM_CFG + 0x4c
EDRAM_E3_DRT  = EDRAM_CFG + 0x50
EDRAM_E0_REF_LAST_ROW  = EDRAM_CFG + 0x84
EDRAM_E1_REF_LAST_ROW  = EDRAM_CFG + 0x88
EDRAM_E2_REF_LAST_ROW  = EDRAM_CFG + 0x8c
EDRAM_E3_REF_LAST_ROW  = EDRAM_CFG + 0x90
com = r2d2.CMenu(r2d2.IUart('COM19', 1843200))

def r(addr):
    print(hex(com.read(addr)))

def w(addr, data):
    com.write(addr, data)

com.set_pll(260000000)
com.set_pll(260000000)

#drt
w(EDRAM_E0_DRT, 0x10)
w(EDRAM_E1_DRT, 0x10)
w(EDRAM_E2_DRT, 0x10)
w(EDRAM_E3_DRT, 0x10)

#last row to refresh
w(EDRAM_E0_REF_LAST_ROW, 0x3)
w(EDRAM_E1_REF_LAST_ROW, 0x3)
w(EDRAM_E2_REF_LAST_ROW, 0x3)
w(EDRAM_E3_REF_LAST_ROW, 0x3)

w(EDRAM_ENABLES, 0xf0f0)
w(EDRAM_OCP0, 0x12345678)
r(EDRAM_OCP0)

com.send_raw('l 2')
time.sleep(3)

w(EDRAM_OCP0, 0x12345678)
r(EDRAM_OCP0)
